// schema.prisma - UPDATED VERSION WITH REQUIRED FIELDS FOR MYTHOSNET

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InvoiceStatus {
  UNPAID
  PAID
  CANCELED
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

model Blockchain {
  id            String   @id @default(uuid())
  name          String   // ✅ REMOVED @unique constraint
  ubid          String   @unique
  bnsName       String?  @unique
  apiKey        String   @unique
  networkType   String
  chainProtocol String
  // ... rest of your fields remain the same
  chainId       String?  @unique
  rpcUrl        String?
  explorerUrl   String?
  nativeCurrency String?
  decimals      Int      @default(18)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  users        User[]
  invoices     Invoice[]
  identities   CrossChainIdentity[]
  transactions CrossChainTransaction[]
  
  // Performance indexes
  @@index([name], name: "idx_blockchain_name")
  @@index([ubid], name: "idx_blockchain_ubid")
  @@index([chainId], name: "idx_blockchain_chain_id")
  @@index([isActive], name: "idx_blockchain_active")
}


model Plan {
  id         String   @id @default(uuid())
  name       String   @unique
  // ✅ Added required fields for enhanced plan management
  displayName String?
  type       String?  @default("FREE")
  price      Int      @default(0)
  queryLimit Int      @default(20)
  txnLimit   Int?
  userLimit  Int      @default(1)
  maxWallets Int      @default(1)
  features   String[] @default([])
  description String?
  sortOrder  Int?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users         User[]         @relation("UserPlan")
  organizations Organization[] @relation("OrgPlan")

  // ✅ Performance indexes
  @@index([name], name: "idx_plan_name")
  @@index([type], name: "idx_plan_type")
  @@index([isActive], name: "idx_plan_active")
}

model Organization {
  id          String   @id @default(uuid())
  name        String
  description String?
  ownerId     String
  planId      String?
  // ✅ Added required fields for organization management
  settings    Json?    @default("{}")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plan        Plan?    @relation("OrgPlan", fields: [planId], references: [id], onDelete: SetNull)
  owner       User     @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     User[]   @relation("OrgMembers")

  // ✅ Performance indexes
  @@index([ownerId], name: "idx_org_owner")
  @@index([planId], name: "idx_org_plan")
  @@index([isActive], name: "idx_org_active")
}

model User {
  id            String     @id @default(uuid())
  blockchainId  String
  blockchain    Blockchain @relation(fields: [blockchainId], references: [id])
  walletAddress String
  name          String?
  email         String?    @unique
  bio           String?
  location      String?
  avatar        String?
  creditScore   Int        @default(0)
  metadataURI   String
  identityHash  String?    @unique
  kycStatus     KycStatus?
  isActive      Boolean    @default(true)
  isVerified    Boolean    @default(false)
  lastLoginAt   DateTime?
  lastLogoutAt  DateTime?   // ⬅️ Added for logout
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  invoiceCount  Int        @default(0)
  planId        String?
  plan          Plan?      @relation("UserPlan", fields: [planId], references: [id], onDelete: SetNull)
  orgId         String?
  organization  Organization? @relation("OrgMembers", fields: [orgId], references: [id], onDelete: SetNull)
  ownedOrgs     Organization[] @relation("OrgOwner")
  subscriptionId     String?
  subscriptionStatus String?  @default("inactive")
  subscriptionEndDate DateTime?
  trialStartDate     DateTime?
  trialUsed          Boolean  @default(false)
  queriesUsed    Int       @default(0)
  queriesLimit   Int?
  queryResetDate DateTime?
  queryCount     Int          @default(0)
  lastQueryReset DateTime?
  apiKey         String?   @unique
  refreshToken   String?
  preferences    Json?     @default("{}")
  privacySettings Json?    @default("{}")
  transactions  Transaction[]
  invoices      Invoice[]
  crossChainIds CrossChainIdentity[]
  crossChainTxs CrossChainTransaction[]
  creditHistory CreditScoreHistory[]
  queryUsages   QueryUsage[]

  @@unique([blockchainId, walletAddress])
  @@index([walletAddress, blockchainId], name: "idx_user_wallet_blockchain")
  @@index([walletAddress], name: "idx_user_wallet_fast")
  @@index([blockchainId], name: "idx_user_blockchain")
  @@index([email], name: "idx_user_email")
  @@index([planId], name: "idx_user_plan")
  @@index([createdAt], name: "idx_user_created")
  @@index([queriesUsed], name: "idx_user_queries_used")
  @@index([queryResetDate], name: "idx_user_query_reset")
  @@index([isActive], name: "idx_user_active")
  @@index([lastLoginAt], name: "idx_user_last_login")
  @@index([lastLogoutAt], name: "idx_user_last_logout") // ⬅️ Add this index
}


model CrossChainIdentity {
  id            String     @id @default(uuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  blockchainId  String
  blockchain    Blockchain @relation(fields: [blockchainId], references: [id])
  walletAddress String
  proofHash     String
  // ✅ Added required cross-chain identity fields (from API requirements)
  metadataURI   String?
  chainName     String?
  planName      String?    @default("Free")
  planSource    String?    @default("inherited")
  parentUserId  String?
  status        String     @default("approved")
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  creditScore   Int        @default(0)
  invoiceCount  Int        @default(0)

  // ✅ Relations for CrossChain-specific records
  invoices      Invoice[]  @relation("CrossChainIdentityToInvoice")
  creditHistory CreditScoreHistory[] @relation("CrossChainIdentityCreditHistory")

  // ✅ Critical performance indexes for cross-chain wallet lookups
  @@unique([blockchainId, walletAddress])
  @@unique([userId, blockchainId, walletAddress])
  @@index([walletAddress, blockchainId], name: "idx_crosschain_wallet_blockchain")
  @@index([userId], name: "idx_crosschain_user_fast")
  @@index([walletAddress], name: "idx_crosschain_wallet_fast")
  @@index([blockchainId], name: "idx_crosschain_blockchain")
  @@index([parentUserId], name: "idx_crosschain_parent_user")
  @@index([planName], name: "idx_crosschain_plan_name")
  @@index([createdAt], name: "idx_crosschain_created")
  @@index([isActive], name: "idx_crosschain_active")
}

model Transaction {
  id            String            @id @default(uuid())
  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoiceId     String? 
  amount        Float
  // ✅ Added required transaction tracking fields
  currency      String            @default("USD")
  type          String
  status        TransactionStatus
  hash          String?           @unique
  blockNumber   BigInt?
  gasUsed       BigInt?
  gasPrice      BigInt?
  riskScore     Float?
  failureReason String?
  metadata      Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  invoice       Invoice?          @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  // ✅ Performance indexes
  @@index([userId], name: "idx_transaction_user")
  @@index([invoiceId], name: "idx_transaction_invoice")
  @@index([status], name: "idx_transaction_status")
  @@index([createdAt], name: "idx_transaction_created")
  @@index([hash], name: "idx_transaction_hash")
  @@index([type], name: "idx_transaction_type")
  @@index([currency], name: "idx_transaction_currency")
}

model CrossChainTransaction {
  id                 String     @id @default(uuid())
  userId             String
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceBlockchainId String
  sourceBlockchain   Blockchain @relation(fields: [sourceBlockchainId], references: [id])
  destinationAddress String
  // ✅ Added required cross-chain tracking
  destinationChainId String?
  amount             Float
  assetType          String
  status             String
  proofHash          String
  bridgeProtocol     String?
  bridgeFee          Float?
  estimatedTime      Int?
  actualTime         Int?
  metadata           Json?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // ✅ Performance indexes
  @@index([userId], name: "idx_crosschain_tx_user")
  @@index([sourceBlockchainId], name: "idx_crosschain_tx_blockchain")
  @@index([status], name: "idx_crosschain_tx_status")
  @@index([destinationAddress], name: "idx_crosschain_tx_destination")
  @@index([destinationChainId], name: "idx_crosschain_tx_dest_chain")
  @@index([createdAt], name: "idx_crosschain_tx_created")
  @@index([bridgeProtocol], name: "idx_crosschain_tx_bridge")
}

model Invoice {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  blockchainId   String
  blockchain     Blockchain    @relation(fields: [blockchainId], references: [id])
  walletAddress  String 
  // ✅ Added required invoice fields
  invoiceNumber  String?       @unique
  title          String?
  amount         Float
  currency       String        @default("USD")
      
  ethAmount      Float?
  weiAmount      String?
  ethPrice       Float?
  exchangeRate   Float?
  paymentHash    String?
  paidAt         DateTime?
  description    String?       @default("")
  notes          String?
  // ✅ Added payment tracking
  paymentMethod  String?
  paymentAddress String?
  confirmations  Int           @default(0)
  dueDate        DateTime
  status         InvoiceStatus @default(UNPAID)
  ipfsHash       String?
  tokenized      Boolean       @default(false)
  tokenAddress   String?
  escrowAddress  String?
  subscriptionId String?
  fee            Float?        @default(0)
  tax            Float?        @default(0)
  // ✅ Added invoice management
  tags           String[]      @default([])
  isRecurring    Boolean       @default(false)
  recurringPeriod String?
  parentInvoiceId String?
  expiresAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  transactions   Transaction[]

  // ✅ CrossChainIdentity relation (optional)
  crossChainIdentityId String?
  crossChainIdentity   CrossChainIdentity? @relation("CrossChainIdentityToInvoice", fields: [crossChainIdentityId], references: [id], onDelete: SetNull)

  // ✅ Performance indexes
  @@index([userId], name: "idx_invoice_user")
  @@index([walletAddress, blockchainId], name: "idx_invoice_wallet_blockchain")
  @@index([status], name: "idx_invoice_status")
  @@index([crossChainIdentityId], name: "idx_invoice_crosschain")
  @@index([dueDate], name: "idx_invoice_due_date")
  @@index([createdAt], name: "idx_invoice_created")
  @@index([paymentHash], name: "idx_invoice_payment_hash")
  @@index([invoiceNumber], name: "idx_invoice_number")
  @@index([currency], name: "idx_invoice_currency")
  @@index([isRecurring], name: "idx_invoice_recurring")
  @@index([expiresAt], name: "idx_invoice_expires")
}

model CreditScoreHistory {
  id                     String   @id @default(uuid())
  userId                 String?
  user                   User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ✅ CrossChainIdentity credit score history
  crossChainIdentityId   String?
  crossChainIdentity     CrossChainIdentity? @relation("CrossChainIdentityCreditHistory", fields: [crossChainIdentityId], references: [id], onDelete: SetNull)
  
  // ✅ Added required credit score tracking
  previousScore          Int?
  score                  Int
  change                 Int?
  reason                 String?
  factors                Json
  paymentHistory         Float?
  creditUtilization      Float?
  accountAge             Float?
  mixOfCredit            Float?
  recentInquiries        Float?
  createdAt              DateTime @default(now())

  // ✅ Performance indexes
  @@index([userId], name: "idx_credit_history_user")
  @@index([crossChainIdentityId], name: "idx_credit_history_crosschain")
  @@index([createdAt], name: "idx_credit_history_created")
  @@index([score], name: "idx_credit_history_score")
  @@index([change], name: "idx_credit_history_change")
}

model QueryUsage {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month     Int
  year      Int
  used      Int      @default(0)
  // ✅ Added required usage tracking
  limit     Int?
  apiCalls       Int @default(0)
  creditQueries  Int @default(0)
  invoiceQueries Int @default(0)
  resetAt   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ Critical performance indexes for usage lookups
  @@unique([userId, month, year])
  @@index([userId, month, year], name: "idx_query_usage_user_period")
  @@index([userId], name: "idx_query_usage_user")
  @@index([year, month], name: "idx_query_usage_period")
  @@index([resetAt], name: "idx_query_usage_reset")
}
